{% extends 'xul/page.html'%}
{% block styles %}
  <style type="text/ample+css">
/*    @namespace xul "http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul";
    xul|tree#dataset-tree {
    }
*/  </style>
{% endblock %}
{% block scripts %}
{{g.tree.scripts|join('\n')|safe}}
<script type="text/javascript" src="{{url_for('rest.static', filename='ample-rest.js')}}"></script>
<script type='application/javascript'>ample.bind('load', function(event) {
    $('#dataset-tree-box').attr('height', window.innerHeight - 16)
})
window.onresize = function(event) {
    $('#dataset-tree-box').attr('height', event.target.innerHeight - 16)
}

var rest = ample.restful('url', ample.restful.UPDATERS)
var edit = ample.restful('editor', ample.restful.UPDATERS, {headers:{'X-View-Name':'editor'}})
ample.rest = rest
ample.edit = edit
function prompt_or_cancel(message) {
    var value = prompt(message)
    if(_.isNull(value)) throw 'cancel'
    return value
}
function parent(node, name) {
    if(node.__proto__.localName == name) {
        return node
    }
    if(!node.parentNode) {
        throw 'Not existent parent "' + name + '"'
    }
    return parent(node.parentNode, name)
}

function deletenode(node, data){
    var selection = ample.rest.context.get(node);
    var update_root = _.after(selection.length, function(item) {
        rest(item.parentNode).with("GET")
    });
    _.map(selection, function(item) {
        item.setAttribute('open', false)
        if(item.attributes.url) {
            ample.ajax({
                data:data || null,
                url: item.attributes.url,
                type: "DELETE",
                complete: _.bind(update_root, {}, item)
            })
        }
    })
}
var dataset = {
    delete: function(menuitem) {
        deletenode(menuitem, null)
    },
    rebase: function(menuitem, copy){
        if (_.isUndefined(copy)){
            var copy = false
        }
        var selection = rest.context.get(menuitem);
        var update_root = _.after(selection.length, function(item) {
            rest(item.parentNode).with("GET")
        });
        _.map(selection, function(item) {
            $(item.parentNode.items).attr('open', false)
            try{
                var name = prompt_or_cancel('Enter datset new name')    
            }catch(err){
                if (err=='cancel'){
                    return
                }
            }
            
            if(item.attributes.url) {
                ample.ajax({
                    data:{name:name, copy:copy},
                    url: item.attributes.url,
                    type: "POST",
                    complete: _.bind(update_root, {}, item)
                })
            }
        })        
    }
}
var datasource = {
    create:function(menuitem, type){
        var selection = rest.context.get(menuitem);
        _.map(selection, function(item){
            $(item.parentNode.items).attr('open', false)
            ample
            .rest(item.children)
            .with("PUT", {type:type, name:function(){return prompt_or_cancel('Enter datasource name')}},
                function(){$(item.parentNode.items).attr('open', true)})
        })
    return true
    },
    delete: function(menuitem) {
        deletenode(menuitem, null)
    },
    deletetree: function(menuitem) {
        deletenode(menuitem, {subnodes:true})
    },
    change_type: function(menuitem, type){
        var selection = rest.context.get(menuitem);
        var update_root = _.after(selection.length, function(item) {
            rest(item.parentNode).with("GET")
        });
        _.map(selection, function(item) {
            $(item.parentNode.items).attr('open', false)
            if(item.attributes.url) {
                ample.ajax({
                    data:{typename:type},
                    url: item.attributes.url,
                    type: "POST",
                    complete: _.bind(update_root, {}, item)
                })
            }
        })
    }
}
function show_editor(treeitem){
    edit('#editor-box').using(treeitem).with('GET')
}
</script>
{% endblock %}
{%- block popupset %}
{%- for popupset in g.tree.popupsets %}
{% include popupset with context %}
{%- endfor %}
<xul:tooltip id="moretip" orient="vertical" oneffectend="$('#tree-body').attr('tooltip', '')">
    <xul:description value="Right click on object for context actions"/>
    <xul:description value="Right click on free space to create dataset"/>
</xul:tooltip>
{% endblock %}
{%- block body %}
<xul:hbox>
    <xul:vbox id='dataset-tree-box' flex='1' align='stretch'>
        <xul:tree flex='2' id='tree'>
            <xul:treecols>
              {% for id, label in zip(g.tree.cell_keys, g.tree.cell_labels)%}
              <xul:treecol class='{{id}}-header' minwidth='450' id='{{id}}' primary='true' label='{{label}}'/>
              {% endfor %}
            </xul:treecols>
            <xul:treebody id='tree-body' {% if g.item.view.context %} context="{{g.item.view.context}}"{% endif %} onmouseenter="this.setAttribute('tooltip', 'moretip')">
            {%- include template with context %}
            </xul:treebody>
        </xul:tree>
        <xul:hbox flex='1' id='dataset-view-box' hidden='true'>
        </xul:hbox>
    </xul:vbox>
    <xul:vbox flex='1'>
        <xul:groupbox id='editor-box'></xul:groupbox>
    </xul:vbox>
</xul:hbox>
{%- endblock %}